# Радио модули Навига

**Purpose:** Живой документ — выжимка из мануалов радиомодулей, используемых в Навига. Источник решений по пресетам и HAL. В будущем сюда добавляются новые модули.

**Related:** [OOTB Radio preset v0](../product/ootb_radio_preset_v0.md), [Radio channel mapping v0](../product/radio_channel_mapping_v0.md).

---

## A) Обзор

- **Модули:** E220-400T30D (LLCC68), E22-400T30D (SX1262), E22-400T33D. Сейчас используются **UART-версии**; SPI — позже.
- **Ключевые отличия:** дефолты по производителю различаются (sub-packet, частично режимы); для единого OOTB пресета все параметры задаём явно (см. раздел K).

---

## B) Пины и режимы (общее)

- **Подключение к ESP32:** UART TX/RX (перекрёстно: TX MCU → RX модуля, RX MCU → TX модуля), питание 3.3 V, GND. Управление режимом: **M0**, **M1** (входы), **AUX** (выход «готов», опционально для блокирующего ожидания).
- **Режимы (по мануалам):**

| M1 | M0 | Режим   | Описание |
|----|----|---------|----------|
| 1  | 1  | Sleep   | Низкое потребление. |
| 1  | 0  | Normal  | Прозрачная передача/приём. |
| 0  | 1  | WOR     | Wake-on-Radio (в seed не используется). |
| 0  | 0  | Config  | Конфигурация по UART (регистры/команды). |

- **Практика:** для чтения/записи конфига перевести M0/M1 в Config (0,0), выполнить обмен по UART, затем вернуть в Normal (1,0). После смены параметров — readback и логирование для отладки.

---

## C) RF канал / маппинг частот

- **Формула по мануалам:** частота (MHz) = база + CH × шаг. Для 433 MHz band: диапазон CH задаётся мануалом (типично **CH = 0..83**, шаг **1 MHz**; точный диапазон — в даташите модуля).
- **Якорь Naviga:** продуктовый **ChannelId = 1** (Public) → **module CH = 0x17** (23) → **433.125 MHz**.
- **Private:** ChannelId = 2..N; N выводится из допустимого диапазона CH модуля (жёстко N не зашиваем). Маппинг ChannelId → CH: [radio_channel_mapping_v0.md](../product/radio_channel_mapping_v0.md).

---

## D) Таблица Air data rate (UART «air rate»)

- **Доступные скорости по мануалам** (over-the-air, не UART baud): 2.4k, 4.8k, 9.6k, 19.2k, 38.4k, 62.5k (значения могут незначительно отличаться между E220/E22 — уточнять по даташиту).
- **Naviga OOTB по умолчанию:** **2.4 kbps** — приоритет дальности; beacon ~40 B укладывается в бюджет **≤300 ms** по эфиру.

---

## E) UART link (связь MCU ↔ модуль)

- **Naviga seed default:** **9600 8N1**. При необходимости можно повысить позже, если станет узким местом.

---

## F) Уровни мощности

- **По мануалам:** несколько ступеней TX power (конкретные значения и шаги — в даташите). Типичный диапазон до 30 dBm (E220-400T30D / E22-400T30D).
- **Naviga OOTB default:** **минимальная доступная** ступень (номинально режим «21 dBm»; по отзывам сообщества эффективная мощность ~19–20 dBm). Расширенный/высокий уровень мощности — зона ответственности пользователя (будущий UX).

---

## G) Sub-packet length (сегментация пакетов)

- **Дефолты по производителю:** E220 — 200 B, E22 — 240 B.
- **Naviga единый default:** **128 bytes** — явный выбор для кросс-модульной совместимости. Не дополняет payload; влияет только на сегментацию при длинных сообщениях.

---

## H) RSSI append

- **Включение:** опция «append RSSI» в конфиге модуля (по умолчанию **OFF** у обоих модулей). Включается отдельно для E220 и E22 (команды/регистры — по мануалу).
- **Формат на приёме:** payload + **trailing RSSI byte(s)** в точности как описано в мануале (число байт и порядок — из документации).
- **Naviga seed default:** **RSSI append ON** (для UART-телеметрии и отображения уровня сигнала).

---

## I) LBT (listen-before-talk)

- **Опция** в конфиге; **default по мануалу — OFF**. В мануалах указано возможное поведение при включённом LBT (задержка TX, макс. ожидание и т.п.).
- **Naviga seed default:** **LBT OFF** (детерминированные тайминги); контенция обрабатывается в ПО (jitter + ограниченный backoff/retry).

---

## J) Encryption / WOR

- **Опции** есть в модулях; **Naviga seed defaults:** **encryption OFF**, **WOR OFF** (публичная сеть; Wake-on-Radio не используется в seed).

---

## K) OOTB radio preset (краткий чеклист)

- **channel_id:** 1 = Public; 2..N = private (N из диапазона CH).
- **air_data_rate:** 2.4 kbps.
- **UART:** 9600 8N1.
- **TX power:** минимум (доступная ступень).
- **RSSI append:** ON.
- **LBT:** OFF.
- **sub_packet_length:** 128 bytes.
- **WOR:** OFF; **encryption:** OFF.

Полная спецификация пресета и маппинг каналов: [ootb_radio_preset_v0.md](../product/ootb_radio_preset_v0.md), [radio_channel_mapping_v0.md](../product/radio_channel_mapping_v0.md).

---

## L) Источники

- **Внешние ссылки (не хранятся в репозитории):**
  - `E22-400T30D_UserManual_EN_v1.1.pdf`
  - `e220-400t30d-30dbm-lora-wireless-module-manual.pdf`
- Мануалы могут храниться локально на машине разработчика или в общем хранилище команды; при расхождении с документом приоритет — у актуального даташита производителя.
