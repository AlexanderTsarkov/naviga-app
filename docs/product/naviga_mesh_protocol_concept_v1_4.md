# **Навига Mesh: концептуальная спецификация протокола v1.4**

## **1\. Цель протокола**

**Навига** — система групповой навигации для охоты и похожих сценариев: десятки людей и собак в лесном массиве площадью несколько квадратных километров.

Задача mesh-протокола:

* доставлять геопакеты (координаты нод) от любой ноды к максимально возможному числу других нод;

* минимизировать число ретрансляций и «засорение» эфира;

* оставаться децентрализованным (никакого центрального маршрутизатора);

* не требовать 100% доставки каждого пакета (приемлем небольшой процент потерь).

---

## **2\. Краткое неформальное описание логики**

Эта секция — «по-человечески».

1. **Origin шлёт геопакет и сам решает, кто уже “накрыт”.**  
    Перед отправкой origin смотрит на тех нод, от которых он **недавно получал пакеты напрямую** — своих `direct_neighbor`. Среди них выбирает тех, кого с высокой вероятностью накрывает текущим сигналом, и **явно помечает их в `covered_mask`**. Сам origin тоже помечает себя как covered.

2. **Каждый, кто слышит пакет, объединяет информацию и использует её.**  
    Получив пакет, нода Me:

   * обновляет **локальную объединённую маску** `best_mask(origin, seq)` как OR всех виденных масок:  
      `best_mask := best_mask OR packet.covered_mask`;

   * смотрит, кто из её **прямых соседей** (`direct_neighbor`) ещё **не помечен** в `best_mask`;

   * это множество и есть её `Potential(Me)` — те, ради кого есть смысл ретранслировать.

3. Если таких нод нет → Me молчит.  
    Если есть → Me оценивает вероятность достучаться до них (`QoD`), считает свою полезность и планирует задержку.

4. **Полезные ноды шлют раньше, бесполезные — позже или вовсе не шлют.**  
    Чем выше полезность Me (суммарная вероятность достучаться до непокрытых соседей), тем **меньшая задержка**.

5. **Во время ожидания все смотрят, не сделал ли кто-то работу за них.**  
    Если за время задержки Me получает более свежую копию того же `(origin_id, seq)`:

   * она обновляет `best_mask` через OR;

   * заново пересчитывает `Potential(Me)` уже относительно новой `best_mask`;

   * если все её прямые соседи теперь covered → она окончательно отказывается от ретрансляции;

   * если ещё остались непокрытые → заново планирует отправку с новой задержкой.

6. **Когда нода всё-таки ретранслирует, она берёт лучшую маску и добавляет своих.**  
    Перед отправкой Me:

   * начинает с `best_mask(origin, seq)`;

   * среди своих `direct_neighbor` выбирает тех, кого **готова считать накрытыми именно своим сигналом**;

   * для их `short_id` ставит биты `1` в маске;

   * при необходимости помечает и себя;

   * отправляет пакет с этой объединённой маской как `covered_mask`.

7. **Маска постепенно заполняется, волна затухает сама.**  
    По мере распространения пакета всё больше нод получают статус covered:

   * каждый следующий ретранслятор видит всё меньше кандидатов в `Potential(Me)`;

   * новые ретрансляции запускаются только ради тех, кто ещё не помечен covered и с кем у ретранслятора есть **недавний прямой контакт**;

   * когда непокрытых прямых соседей больше нет, ретрансляции просто прекращаются.

---

## **3\. Предпосылки и ограничения**

### **3.1. Окружение**

* **Диапазон частот.**  
   Поддиапазон 400–500 МГц (например, 433 МГц), LoRa-модуляция.

* **Дистанции.**  
   Реальные рабочие расстояния:

  * 0.1–3 км в лесу (типовой сценарий),

  * до \~5 км в лучших условиях (открытая местность, чистый эфир).

* **Скорости.**  
   Все ноды движутся относительно медленно по меркам радиопротокола: люди и собаки в пересечённой местности. Это позволяет использовать интервалы обновления координат в несколько секунд и больше.

* **Топология.**  
   Ноды распределены в облаке / на линии, без гарантированной видимости «все со всеми». Сеть строится как радиомеш с частично перекрывающимися зонами покрытия.

* **LoRa-профиль.**  
   Конкретный набор параметров LoRa (SF, BW, CR, мощность) выбирается пользователем/организатором охоты перед началом сессии, по аналогии с выбором частоты голосовой рации.  
   Протокол Навига Mesh исходит из того, что для выбранного профиля известно **приблизительное время передачи одного геопакета** (airtime), и все оценки нагрузки опираются именно на это время.

   При росте числа нод размер зоны охоты обычно **не увеличивается пропорционально**: плотность устройств в той же географии растёт, а средние расстояния между ними уменьшаются. Это даёт возможность осознанно переходить к более «быстрым» LoRa-профилям (меньший airtime пакета ценой потенциального снижения максимальной дальности прямой связи), если сценарий охоты и реальная геометрия группы это позволяют. Таким образом, выбор LoRa-профиля — одна из трёх основных «ручек» масштабируемости системы.

---

### **3.2. Размер сети**

* **Технический максимум.**  
   Жёсткий лимит протокола по маске `covered_mask` — **64 ноды** (64 возможных `short_id`).

* **Проектный максимум.**  
   Максимальное осознанно поддерживаемое число участников в одной сессии — **до 50 нод**. Это включает всех: собак, загонщиков, стрелков, сервисные устройства.

* **Реалистичный рабочий диапазон.**  
   С учётом радиобюджета и типичных интервалов обновления по ролям (см. 3.3 и 3.4) практическим рабочим диапазоном считается **20–25 активных нод** в одной сети при базовом профиле уровня `SF9 / BW125 кГц / CR4/5`.

**Короткие ID.**  
 Каждой ноде в сессии назначается локальный короткий ID:

 `short_id ∈ [0..63]`

*  Эти `short_id` используются внутри mesh-протокола везде: в `covered_mask`, ссылках на origin, bridge-hop и т.п. Механизм раздачи `short_id` — часть управления сессией и рассматривается отдельно от протокола mesh.

---

### **3.3. Роли и временные параметры**

Каждая нода имеет роль (примерно):

* `dog` — собака / быстрый объект;

* `driven` — загонщик;

* `shooter` — стрелок / более стационарный участник;

* `service` — вспомогательные роли (машина, база и т.п.).

От роли наследуются два уровня временных параметров.

#### **3.3.1. Базовый интервал обновления позиции**

`role_pos_update_interval_X` — **желаемый** (базовый) интервал геопакетов по роли X (в секундах). Он задаётся из соображений требуемой точности слежения:

* собака: порядок 5 с (точность \~5 м при типичной скорости в лесу);

* загонщик: порядок 10–15 с;

* стрелок: десятки секунд (допускается «размазка» 25+ метров).

Это не жёсткая гарантия, а целевой минимум в идеальных условиях, когда эфир не перегружен.

#### **3.3.2. Максимальное время молчания**

`max_silence_factor_X` — целочисленный множитель (обычно 3–5), задающий, сколько базовых интервалов нода может «промолчать», если не набралось смысла слать новую позицию:

`max_silence_interval_X = role_pos_update_interval_X * max_silence_factor_X`

Нода обязана выдать геопакет **не реже**, чем раз в `max_silence_interval_X`, даже если почти не двигается. Если молчание дольше — позиция этой ноды для протокола считается устаревшей.

Чтобы не отрезать прямой линк из\-за задержек радио/очередей, вводится:

* `link_slack_factor ≥ 1.0` — глобальный или профильно-заданный коэффициент (типично 1.05–1.2);

`direct_link_valid_window_X =`

    `max_silence_interval_X * link_slack_factor`

Пока:

`now - last_direct_time_X <= direct_link_valid_window_X`

нода X считается актуальным прямым соседом (`direct_neighbor`).

Протокол опирается именно на `max_silence_interval_X`, а не на фактический текущий интервал отправки. Это позволяет динамически растягивать реальные интервалы обновления (см. 3.4.3), не ломая базовую логику mesh.

---

### **3.4. Радиобюджет и нагрузка**

Здесь протокол исходит не из «возможностей радио», а из требований к сети.

#### **3.4.1. От требований к эфиру — к времени пакета**

Типовой сценарий:

* **25 нод** в сети;

* средний интервал обновления координат (по всем ролям в смеси) — порядка **30 секунд**;

* оригинальные геопакеты (исходные апдейты позиций) не должны занимать более **\~30% эфирного времени**, остальное нужно оставить на ретрансляции и служебные сообщения.

При таких вводных средний бюджет эфирного времени на один оригинальный пакет:

`T_пакета ≈ 30 с / 25 нод * 0.3 ≈ 0.36 с (360 мс)`

То есть, чтобы сеть была работоспособна, **один геопакет должен укладываться примерно в 200–300 мс airtime**.

Грубая оценка размеров геопакета Навига (координаты origin \+ служебные поля \+ `covered_mask`) даёт величину порядка **40 байт** — при разумных настройках LoRa это как раз даёт время передачи в диапазоне 150–300 мс. Следующий «шаг» в сторону более медленных настроек уже уводит нас в секунды на пакет, что неприемлемо для 20–25 нод.

Отдельная прагматичная установка: **предпочтительны настройки, дающие максимальную дальность прямой связи**, потому что это уменьшает число необходимых ретрансляций.

#### **3.4.2. Выводы для структуры пакета и размеров сети**

Из этого следуют ключевые ограничения:

* **Геопакет — самый частый и самый важный тип трафика.**  
   Любое увеличение его размера должно рассматриваться как исключение и отдельно обосновываться.

* **Размер геопакета должен оставаться компактным (порядка 40 байт).**  
   Предпочтение отдается:

  * дельта-кодированию координат (от базовой точки сессии),

  * устранению дублирующихся полей.

* **Реалистичный размер сети при базовых интервалах по ролям — 20–25 нод.**  
   При большем числе нод протокол должен либо:

  * использовать более «быстрый» LoRa-профиль (меньший airtime пакета),

  * либо растягивать интервалы обновлений до верхней границы `max_silence_interval_X`,

  * либо комбинировать оба подхода.

При предельной компрессии частоты (все роли работают ближе к `max_silence_interval_X`) сеть остаётся работоспособной даже при техническом максимуме 64 ноды — за счёт того, что суммарное эфирное время, занятое оригинальными геопакетами, остаётся в разумных пределах, а остальное пространство отдаётся под ретрансляции.

#### **3.4.3. Динамическая частота по ролям (принцип)**

Для каждой роли X фактический интервал отправки может отличаться от базового:

* в идеальных условиях (свободный эфир) интервал стремится к `role_pos_update_interval_X`;

* при высокой загрузке эфира он может плавно увеличиваться в сторону `max_silence_interval_X`.

При этом:

* для ролей с высокой важностью (собаки) рост интервала должен быть минимальным и последним;

* для менее критичных ролей (стрелки, сервисные ноды) интервалы могут увеличиваться первыми и заметнее.

Протокол mesh остаётся корректным, пока реальные интервалы **не хуже (не реже)**, чем `max_silence_interval_X`. Всё остальное — политика верхнего уровня (алгоритм, который по оценке загрузки эфира двигает фактические интервалы разных ролей внутри допустимых границ).

---

### **3.5. Ограничения по истории**

Телефон с приложением Навига может вести **полную историю передвижения** за сессию.

Узел на ESP32 для целей mesh-протокола обязан хранить только **короткую историю** по каждой ноде (минимум `last_pos`, опционально 2–N последних точек). Этого достаточно для:

* оценки качества линка (расстояние, `RSSI`, `SNR`);

* грубой оценки движения (в продвинутых реализациях).

Хранение полного трека на самой ноде возможно как расширение, но **не является частью базового mesh-протокола v1.x**.

---

## **3\. Предпосылки и ограничения**

### **3.1. Окружение**

* **Диапазон частот.**  
   Поддиапазон 400–500 МГц (например, 433 МГц), LoRa-модуляция.

* **Дистанции.**  
   Реальные рабочие расстояния:

  * 0.1–3 км в лесу (типовой сценарий),

  * до \~5 км в лучших условиях (открытая местность, чистый эфир).

* **Скорости.**  
   Все ноды движутся относительно медленно по меркам радиопротокола: люди и собаки в пересечённой местности. Это позволяет использовать интервалы обновления координат в несколько секунд и больше.

* **Топология.**  
   Ноды распределены в облаке / на линии, без гарантированной видимости «все со всеми». Сеть строится как радиомеш с частично перекрывающимися зонами покрытия.

* **LoRa-профиль.**  
   Конкретный набор параметров LoRa (SF, BW, CR, мощность) выбирается пользователем/организатором охоты перед началом сессии, по аналогии с выбором частоты голосовой рации.  
   Протокол Навига Mesh исходит из того, что для выбранного профиля известно **приблизительное время передачи одного геопакета** (airtime), и все оценки нагрузки опираются именно на это время.

   Отдельно важно, что при росте числа нод размер зоны охоты обычно **не увеличивается пропорционально**: плотность устройств в той же географии растёт, а средние расстояния между ними уменьшаются. Это даёт возможность осознанно переходить к более «быстрым» LoRa-профилям (меньший airtime пакета ценой потенциального снижения максимальной дальности прямой связи), если сценарий охоты и реальная геометрия группы это позволяют. Таким образом, выбор LoRa-профиля — **одна из трёх основных «ручек» масштабируемости системы**.

---

### **3.2. Размер сети**

* **Технический максимум.**  
   Жёсткий лимит протокола по маске `covered_mask` — **64 ноды** (64 возможных `short_id`).

* **Проектный максимум.**  
   Максимальное осознанно поддерживаемое число участников в одной сессии — **до 50 нод**. Это включает всех: собак, загонщиков, стрелков, сервисные устройства.

* **Реалистичный рабочий диапазон.**  
   С учётом радиобюджета и типичных интервалов обновления по ролям (см. ниже) практическим рабочим диапазоном считается **20–25 активных нод** в одной сети при базовом профиле уровня `SF9 / BW125 кГц / CR4/5`.  
   При большем количестве нод система должна переходить к более агрессивной оптимизации частоты обновлений и/или к более «быстрым» LoRa-настройкам.

**Короткие ID.**  
 Каждой ноде в сессии назначается локальный короткий ID:

 short\_id ∈ \[0..63\]

*  Эти `short_id` используются внутри mesh-протокола везде: в `covered_mask`, ссылках на origin, bridge-hop и т.п.

   Механизм раздачи `short_id` — часть управления сессией и рассматривается отдельно от протокола mesh.

---

### **3.3. Роли и временные параметры**

Каждая нода имеет роль (примерно):

* `dog` — собака / быстрый объект;

* `driven` — загонщик;

* `shooter` — стрелок / более стационарный участник;

* `service` — вспомогательные роли (машина, база и т.п.).

От роли наследуются два уровня временных параметров.

#### **3.3.1. Базовый интервал обновления позиции**

`role_pos_update_interval_X` — **желаемый** (базовый) интервал геопакетов по роли X (в секундах). Он задаётся из соображений требуемой точности слежения:

* собака: порядок 5 с (точность \~5 м при типичной скорости в лесу);

* загонщик: порядок 10–15 с;

* стрелок: десятки секунд (допускается «размазка» 25+ метров).

Это не жёсткая гарантия, а целевой минимум в идеальных условиях, когда эфир не перегружен.

#### **3.3.2. Максимальное время молчания**

`max_silence_factor_X` — целочисленный множитель (обычно 3–5), задающий, сколько базовых интервалов нода может «промолчать», если не набралось смысла слать новую позицию:

max\_silence\_interval\_X \= role\_pos\_update\_interval\_X \* max\_silence\_factor\_X

Нода обязана выдать геопакет **не реже**, чем раз в `max_silence_interval_X`, даже если почти не двигается. Если молчание дольше — позиция этой ноды для протокола считается устаревшей.

Чтобы не отрезать прямой линк из\-за задержек радио/очередей, вводится:

* `link_slack_factor ≥ 1.0` — глобальный или профильно-заданный коэффициент (типично 1.05–1.2);

direct\_link\_valid\_window\_X \=

    max\_silence\_interval\_X \* link\_slack\_factor

Пока:

now \- last\_direct\_time\_X \<= direct\_link\_valid\_window\_X

нода X считается актуальным прямым соседом (`direct_neighbor`).

Протокол **опирается именно на `max_silence_interval_X`**, а не на фактический текущий интервал отправки. Это позволяет динамически растягивать реальные интервалы обновления (см. 2.4.4), не ломая базовую логику mesh.

---

### **3.4. Радиобюджет, масштабируемость и частота обновлений**

Этот подпункт фиксирует физические ограничения радиоканала и рамки, в которых обязан работать протокол.

#### **3.4.1. Airtime геопакета**

Для оценок принимаем типичный профиль:

* `SF9`, `BW = 125 кГц`, `CR = 4/5`;

* геопакет Навига (позиция origin \+ служебные поля \+ `covered_mask`) занимает порядка **40 байт**.

Для такого профиля время передачи одного геопакета составляет примерно:

T\_pkt ≈ 0,29 с (≈ 300 мс)

Иллюстрации:

при 25 нодах один «круг» (каждая нода отправила один геопакет) занимает:

 25 × 0,29 с ≈ 7,25 с

* 

при 50 нодах:

 50 × 0,29 с ≈ 14,5 с

* 

Это подчёркивает, что даже при умеренных настройках LoRa один геоппакет — значимый кусок эфирного времени, и частота обновлений не может быть произвольной.

Протокол Навига Mesh проектируется так, чтобы при выбранном «базовом» профиле один геопакет укладывался в **диапазон 200–300 мс airtime**. Это задаёт жёсткую рамку для структуры пакета и схем сжатия.

#### **3.4.2. Критичность размера геопакета**

Размер геопакета — **сверхкритичный параметр**:

* увеличение полезной нагрузки на несколько байт приводит к заметному росту airtime, особенно на «тяжёлых» профилях (большой SF, узкий BW);

* любые решения, удваивающие размер (вложенные форматы, громоздкие универсальные протоколы и т.п.), резко снижают масштабируемость сети по числу нод и частоте обновлений.

Из этого следуют требования:

1. Геопакет — самый частый и самый важный тип трафика. Все остальные типы сообщений должны передаваться ощутимо реже.

2. Любое увеличение размера геопакета допускается только при отдельном обосновании.  
    Предпочтение отдается:

   * компактным схемам кодирования (в том числе дельта-кодированию координат относительно базовой точки сессии),

   * устранению дублирования данных в пакете.

#### **3.4.3. Лимиты по нодам и нагрузке**

При базовом профиле `SF9/BW125/CR4/5` и примерных интервалах:

* собака: \~5 с;

* загонщик: \~10 с;

* стрелок: \~60 с;

сеть из **25 нод** загружает эфир примерно **на 50% только оригинальными геопакетами** (без учёта ретрансляций). При увеличении числа нод:

* без адаптации частоты обновлений эфир быстро оказывается занят почти полностью исходящими пакетами;

* ретрансляции и помехоустойчивость начинают страдать.

Поэтому протокол исходит из предпосылки:

При числе нод выше \~25 система должна либо:

* переходить к более «быстрым» LoRa-профилям (меньший airtime пакета),

* либо динамически увеличивать интервалы обновлений до `max_silence_interval_X` по ролям,

* либо комбинировать оба подхода.

#### **3.4.4. Динамическая адаптация частоты по ролям**

Для каждой роли X вводится фактический интервал отправки:

optimized\_pos\_update\_interval\_X

который:

* в идеальных условиях стремится к `role_pos_update_interval_X` (желательная частота по точности);

* при высокой загрузке эфира может плавно увеличиваться вплоть до `max_silence_interval_X`.

При этом выполняются условия:

жёстко соблюдается:

 optimized\_pos\_update\_interval\_X ≤ max\_silence\_interval\_X

*   
* приоритеты по ролям:

  * собаки имеют наивысший приоритет — их интервалы растягиваются последними и минимально;

  * загонщики — средний приоритет;

  * стрелки и статичные роли — низкий приоритет, их интервалы могут увеличиваться первыми и сильнее.

Протокол mesh не привязан к конкретным значениям `optimized_pos_update_interval_X`, но **обязан оставаться корректным**, пока реальные интервалы не хуже (не реже), чем соответствующие `max_silence_interval_X`.

#### **3.4.5. Предельный сценарий: технический максимум нод**

Для проверки предельной масштабируемости рассматривается сценарий:

* в сети задействованы все 64 ноды (технический максимум `short_id`);

* роли и максимальные интервалы:

  * 10 собак: `max_silence_interval ≈ 25 с`;

  * 10 загонщиков: `max_silence_interval ≈ 50 с`;

  * 44 стрелка: `max_silence_interval ≈ 150 с`;

* airtime одного геопакета находится в диапазоне `T_pkt = 0,2–0,3 с`.

В этом случае доля эфирного времени, занятая **только оригинальными геопакетами**, составляет:

* при `T_pkt = 0,20 с` — порядка 18%;

* при `T_pkt = 0,25 с` — порядка 22%;

* при `T_pkt = 0,30 с` — порядка 27%.

То есть даже при техническом максимуме нод и работе всех ролей в режиме своих `max_silence_interval_X` сеть остаётся работоспособной, а эфир имеет значительный запас под ретрансляции и помехи.

Протокол Навига Mesh исходит из того, что должен существовать режим, в котором все роли могут быть переведены к своим `max_silence_interval_X`, и в этом режиме сеть не «задыхается» даже при полном заполнении маски `covered_mask`.

---

### **3.5. Ограничения по истории**

Телефон с приложением Навига может вести **полную историю передвижения** за сессию.

Узел на ESP32 для целей mesh-протокола обязан хранить только **короткую историю** по каждой ноде (минимум `last_pos`, опционально 2–N последних точек). Этого достаточно для:

* оценки качества линка (расстояние, `RSSI`, `SNR`);

* грубой оценки движения (в продвинутых реализациях).

Хранение полного трека на самой ноде возможно как расширение, но **не является частью базового mesh-протокола v1.x**.

---

## **4\. Локальное состояние ноды (NodeTable)**

Каждая нода хранит локальное представление о других нодах в **NodeTable**.

### **4.1. Запись о ноде X**

Для каждого `short_id` X:

* `last_pos_X` — последние известные координаты X.

* `pos_history_X` *(опционально)* — короткая история последних позиций X.

* `last_seen_time_X` — время последнего приёма *любой* информации о X (как `origin_id` или `bridge_hop_id`).

* `last_direct_time_X` — время последнего **прямого** приёма кадра по радио от X.

* `link_quality_direct_X`:

  * `RSSI_direct(X→Me)`

  * `SNR_direct(X→Me)`

* Роль X и её временные параметры:

  * `role_id_X`

  * `role_pos_update_interval_X`

  * `max_silence_factor_X`

  * производные:

    * `max_silence_interval_X`

    * `direct_link_valid_window_X`

Дополнительно (опционально):

* `avg_update_interval_X` — оценка фактического среднего периода обновления;

* `pos_est_X` — оценённая текущая позиция X (в базовом варианте \= `last_pos_X`).

Нода также хранит:

* собственную позицию `pos(self)` и, опционально, историю;

* локальный счётчик последовательности `seq_counter` для своих геопакетов;

* кэш `PacketState(origin_id, seq)` (см. ниже).

### **4.2. Прямой сосед и валидность линка**

X считается **`direct_neighbor`** для Me, если:

now \- last\_direct\_time\_X \<= direct\_link\_valid\_window\_X

и есть валидные `RSSI_direct/SNR_direct`.

Если X фигурирует только внутри ретранслированных пакетов (`origin_id` или `bridge_hop_id`), но прямых приёмов давно не было, он становится `mesh_only`.

---

## **5\. Структура геопакета**

Геопакет — широковещательный пакет, несущий координаты origin и служебную информацию.

Поля (концептуально):

* `origin_id` — `short_id` ноды-оригинатора.

* `origin_pos` — позиция origin в сжатом формате.

* `seq` — последовательный номер пакета (уникален в паре `(origin_id, seq)`). **Тип: uint16 (seq16)** — тот же on-air счётчик из поля `seq16` в BeaconCore / Alive (см. [beacon_payload_encoding_v0](../areas/nodetable/contract/beacon_payload_encoding_v0.md) §4.1).

* `hop_count` — число хопов (0 у origin).

* `TTL` — лимит по количеству хопов (страховка).

* `bridge_hop_id` — `short_id` ноды, выполняющей **текущий** ретрансляционный хоп.

* `bridge_hop_pos` — её текущая позиция.

* `covered_mask` — **8 байт**, битовая маска из 64 позиций:

  * `bit(i) = 1` → нода i считается уже накрытой этим пакетом;

  * `bit(i) = 0` → формально ещё не накрыта.

На каждом хопе **обновляются только**:

* `bridge_hop_id`

* `bridge_hop_pos`

* `hop_count`

* `TTL`

* `covered_mask` (путём установки дополнительных единиц).

`origin_id`, `origin_pos`, `seq` неизменны.

---

## **6\. Отправка оригинального геопакета (origin)**

Когда нода S отправляет свой геопакет:

1. Увеличивает `seq_counter` → новый `(origin_id = S, seq)`.

2. Обновляет свою позицию в NodeTable.

Строит множество прямых соседей:

 Neighbors(S) \= { X | now \- last\_direct\_time\_X \<= direct\_link\_valid\_window\_X }

3.   
4. Для каждого X ∈ `Neighbors(S)` оценивает `QoD(S→X)`.

Выбирает подмножество:

 Covered\_by\_origin ⊆ Neighbors(S)

5.  — тех, кого считает надёжно накрытыми текущим сигналом.

### **6.1. Формирование начальной маски и best\_mask**

Origin формирует `initial_mask`:

* `bit(S) = 1`;

* для всех X ∈ `Covered_by_origin` — `bit(X) = 1`;

* остальные биты \= 0\.

В `PacketState(origin=S, seq)`:

* `best_mask = initial_mask`.

### **6.2. Отправка**

Origin шлёт:

* `origin_id = S`, `origin_pos`, `seq`;

* `hop_count = 0`;

* `TTL = TTL_initial`;

* `bridge_hop_id = S`, `bridge_hop_pos = pos(S)`;

* `covered_mask = initial_mask`.

Отдельный self-геопакет в этот момент не нужен.

---

## **7\. Состояние пакета: PacketState(origin, seq)**

Для каждого `(origin_id, seq)` нода хранит:

* `seen` — уже видела этот пакет или нет;

* `scheduled` — есть ли активный таймер на ретрансляцию;

* `sent` — уже отправляла ли сама ретрансляцию;

**`best_mask`** — локально объединённая маска:

 best\_mask(origin, seq)

 инициализируется при первом приёме как `packet.covered_mask` и дальше при каждом новом приёме:

 best\_mask := best\_mask OR packet.covered\_mask

* 

Именно `best_mask`, а не маска конкретного экземпляра, используется для:

* вычисления `Potential(Me)`;

* расчёта полезности/задержки;

* формирования маски при отправке.

---

## **8\. Приём геопакета**

Когда нода Me принимает пакет `(origin_id, seq, ...)`:

1. Определяет физического отправителя `TX` и обновляет его запись:

   * `last_direct_time_TX = now`;

   * `RSSI_direct(TX→Me)`, `SNR_direct(TX→Me)`;

   * если `TX == bridge_hop_id`, обновляет `last_pos_TX = bridge_hop_pos`.

2. Обновляет NodeTable:

   * для `origin_id` — `last_pos`, историю, `last_seen_time = now`;

   * для `bridge_hop_id` — аналогично.

3. Обновляет / создаёт `PacketState(origin_id, seq)`:

   * если запись новая:

     * `seen = true`, `sent = false`, `scheduled = false`;

     * `best_mask = packet.covered_mask`;

   * если уже была:

     * `seen = true`;

     * `best_mask := best_mask OR packet.covered_mask`.

4. Если `sent == true` для этого `(origin, seq)`:

   * пакет используется только для статистики (обновление NodeTable / link-метрик);

   * **решения о ретрансляции больше не принимаются**.

5. Если `sent == false`:

   * если был активный таймер (`scheduled == true`) — его **отменяют**, потому что `best_mask` изменилась;

   * Me перходит к пересчёту `Potential(Me)` и, при необходимости, планированию новой задержки (разделы 9–10).

---

## **9\. Определение `Potential(Me)` на базе best\_mask**

### **9.1. Множество прямых соседей**

Me формирует:

Neighbors(Me) \= { X | now \- last\_direct\_time\_X \<= direct\_link\_valid\_window\_X }

### **9.2. Исключение уже накрытых по best\_mask**

Из `Neighbors(Me)` удаляются ноды с `bit(X) = 1` в **`best_mask(origin, seq)`**.

Остаётся:

Potential(Me) \= { X ∈ Neighbors(Me) | bit(X) \== 0 в best\_mask(origin, seq) }

Если `Potential(Me)` пусто → Me **не ретранслирует** этот пакет.

### **9.3. Оценка `QoD(Me→X)` и полезности**

Для каждого X ∈ `Potential(Me)`:

* оценивается `QoD(Me→X)` на базе:

  * `RSSI_direct(X→Me)`, `SNR_direct(X→Me)`;

  * расстояния между `pos_est_X` и `pos(Me)`;

  * давности данных по X;

  * опционально — роли X.

Полезность:

usefulness(Me) \= Σ QoD(Me→X),  X ∈ Potential(Me)

Если `usefulness(Me)` ≈ 0 → ретрансляция смысла не имеет.

---

## **10\. Планирование задержки и гонка ретрансляторов**

Константы:

* `D_base` — базовая задержка (например, 300–500 мс),

* `D_min`, `D_max` — границы задержки.

Если `usefulness(Me) > 0`:

delay(Me) \= clamp( D\_base / usefulness(Me), D\_min, D\_max )

Дальше:

1. Me ставит таймер на `delay(Me)`:

   * `scheduled = true`.

2. В период ожидания:

   * слушает эфир;

   * при каждом новом пакете того же `(origin, seq)`:

     * обновляет `best_mask` через OR;

     * отменяет текущий таймер;

     * пересчитывает `Potential(Me)` относительно новой `best_mask`;

     * если `Potential(Me)` пусто → `scheduled = false`, ретрансляция не планируется;

     * если не пусто → считает `usefulness(Me)` и ставит **новый** таймер.

3. Если таймер срабатывает, `TTL > 0` и `Potential(Me)` по-прежнему не пусто → Me готовится ретранслировать.

После отправки:

* `sent = true`;

* `scheduled = false`.

---

## **11\. Подготовка и выполнение ретрансляции**

### **11.1. Определение `Covered_by_Me`**

Среди X ∈ `Potential(Me)` Me выбирает:

Covered\_by\_Me ⊆ Potential(Me)

— тех, кого она **готова считать накрытыми своим сигналом** (по QoD или другой эвристике).

### **11.2. Обновление маски по best\_mask**

Перед отправкой:

1. Me берёт актуальную `best_mask(origin, seq)` и копирует её в локальную `out_mask`.

2. Для всех X ∈ `Covered_by_Me` ставит в `out_mask` `bit(X) = 1`.

3. При необходимости, если `bit(Me) == 0` и приём по себе уверенный, может поставить `bit(Me) = 1`.

4. Уже установленные единичные биты не трогает.

После отправки:

* `out_mask` становится `covered_mask` в передаваемом пакете;

* на приёме у других нод эта маска будет влита в их `best_mask` через OR.

### **11.3. Передача**

Me формирует пакет:

* `origin_id`, `origin_pos`, `seq` — без изменений;

* `hop_count = hop_count + 1`;

* `TTL = TTL - 1`;

* `bridge_hop_id = Me`, `bridge_hop_pos = pos(Me)`;

* `covered_mask = out_mask`.

Позиция Me уходит как `bridge_hop_pos`, так что отдельный self-геопакет можно не слать.

---

## **12\. Классификация статусов ноды**

Относительно Me каждая X может быть:

**`direct_neighbor`**  
 Есть свежий прямой линк:

 now \- last\_direct\_time\_X \<= direct\_link\_valid\_window\_X

1.  и валидные `RSSI_direct/SNR_direct`.  
    Такие X входят в `Neighbors(Me)` и могут попасть в `Potential(Me)`.

2. **`mesh_only`**  
    О X есть информация только через чужие геопакеты (`last_seen_time_X` актуально, но `last_direct_time_X` старое).  
    X **не участвует** в `Neighbors(Me)` и не может быть в `Covered_by_Me`.

3. **`unknown / stale`**  
    Про X давно нет никаких данных — запись может быть очищена или помечена как неактивная.

Ретрансляция осуществляется **только ради `direct_neighbor` с `bit(X) = 0` в `best_mask(origin, seq)`**.

---

## **13\. Условия остановки распространения**

Для конкретного `(origin_id, seq)` распространение пакета затухает, когда:

1. У всех потенциальных ретрансляторов `Potential(Me)` пусто (по `best_mask`).

2. `TTL` достиг нуля.

3. Пакет ушёл в область, где просто нет новых нод.

Даже если в сети сформировались несколько «фронтов» одного `(origin, seq)`:

* на каждом узле они **схлопываются в один** `best_mask` (OR всех масок);

* нода прекращает попытки ретрансляции, как только все её прямые соседи покрыты по `best_mask`, независимо от того, с какого фронта пришла последняя копия.

---

## **14\. Ограничения и гарантии**

### **14.1. Размер сети**

* `covered_mask` — 8 байт \= 64 бита → максимум 64 `short_id`.

* Практический целевой максимум — **до 50 активных нод**.

### **14.2. Роль TTL**

`TTL` — **страховочный** механизм:

* основное затухание — за счёт `best_mask` (через неё — фактически за счёт объединённых масок всех фронтов);

* `TTL` обрезает патологии и гарантирует конечность жизни пакета.

Рекомендация:

TTL\_initial \= 8

### **14.3. Гарантии**

Протокол **не гарантирует** доставку каждого пакета каждой ноде.

Обеспечивает:

* быстрое распространение позиции origin в зоны с большим числом непокрытых нод;

* минимизацию числа ретрансляций за счёт гонки по полезности;

* отсутствие бесконечных циклов (дедуп по `sent`, `TTL`);

* устойчивость к ситуации с несколькими независимыми фронтами одного `(origin, seq)` благодаря `best_mask`.

---

## **15\. Открытые параметры и тюнинг**

Нужно зафиксировать:

1. Формулу `QoD(Me→X)`.

2. Правила выбора:

   * `Covered_by_origin` по QoD;

   * `Covered_by_Me` по QoD или иной эвристике.

3. Константы:

   * `max_silence_factor_X` по ролям;

   * `link_slack_factor`;

   * `TTL_initial` (рекомендовано 8);

   * `D_base`, `D_min`, `D_max`;

   * минимальные пороги QoD.

4. Объём `pos_history_X`, наличие продвинутого `pos_est_X`.

Все это — предмет калибровки на полевых тестах.

---

## **16\. Краткий глоссарий / ключевые термины**

(Дополнен пунктом про `best_mask`. Полный глоссарий остаётся отдельным документом.)

* **Нода (node)** — физическое устройство Навига.

* **Сессия** — одна группа/охота. В рамках сессии действуют `short_id`.

* **`short_id`** — локальный ID ноды в сессии (0..63).

* **`origin_id`** — `short_id` ноды, чьи координаты несёт геопакет.

* **`bridge_hop_id`** — `short_id` ноды, делающей текущий хоп.

* **`origin_pos`** — координаты origin.

* **`bridge_hop_pos`** — координаты текущего ретранслятора.

* **`covered_mask`** — 8-байтная маска:

  * `bit(i) = 1` → нода i считается накрытой данным пакетом;

  * `bit(i) = 0` → формально ещё не накрыта.

* **`best_mask(origin, seq)`** — локально объединённая маска для геопакета `(origin, seq)`:

  * вычисляется как OR всех виденных `covered_mask` для этого `(origin, seq)`;

  * используется для расчёта `Potential(Me)` и формирования маски при ретрансляции;

  * обеспечивает устойчивость к нескольким «фронтам» одного пакета.

* **`role_pos_update_interval_X`** — ожидаемый интервал геопакетов по роли X.

* **`max_silence_factor_X`**, **`max_silence_interval_X`** — параметры молчания.

* **`link_slack_factor`**, **`direct_link_valid_window_X`** — параметры валидности линка.

* **`last_seen_time_X`**, **`last_direct_time_X`** — времена последнего приёма вообще и прямого.

* **`direct_neighbor`** — нода X с актуальным прямым линком.

* **`mesh_only`** — нода, известная только по ретрансляциям.

* **`Neighbors(Me)`** — множество прямых соседей Me.

* **`Potential(Me)`** — прямые соседи Me с `bit(X) = 0` в `best_mask(origin, seq)`.

* **`QoD(Me→X)`** — оценка вероятности доставить пакет Me→X.

* **`usefulness(Me)`** — Σ QoD по `Potential(Me)`.

* **`PacketState(origin, seq)`** — состояние обработки пакета: `seen`, `scheduled`, `sent`, `best_mask`. `seq` здесь — uint16 (seq16), тот же on-air счётчик из поля `seq16` в BeaconCore / Alive.

* **`TTL`, `TTL_initial`** — лимит по хопам и стартовое значение.

* **`D_base`, `D_min`, `D_max`** — параметры задержки ретрансляции.

---

